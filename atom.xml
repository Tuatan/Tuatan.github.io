<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Sergey # Blog]]></title>
  <link href="http://sergeysharp.com/atom.xml" rel="self"/>
  <link href="http://sergeysharp.com/"/>
  <updated>2016-02-21T17:54:20-08:00</updated>
  <id>http://sergeysharp.com/</id>
  <author>
    <name><![CDATA[Sergey Baranchenkov]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Vso Ci and Codecov]]></title>
    <link href="http://sergeysharp.com/blog/2016/02/21/vso-ci-and-codecov/"/>
    <updated>2016-02-21T00:00:00-08:00</updated>
    <id>http://sergeysharp.com/blog/2016/02/21/vso-ci-and-codecov</id>
    <content type="html"><![CDATA[<p>﻿&mdash;
layout: post
author: Anastasia Baranchenkova
title: &ldquo;VSO CI and CodeCov&rdquo;
date: 2016-02-21 17:13:28 -0800
comments: true
categories:
- VSO</p>

<h2>- CodeCav</h2>

<p><a href="https://github.com/">GitHub</a> supports a number of services with which you can integrate your repo. I have recently come across <a href="https://codecov.io/#features">CodeCov</a> that provides code coverage results and has a nice integration with the GitHub. I decided to try it out and here what I had to do.</p>

<h2>Prerequisites</h2>

<p>I have C# project hosted in the GitHub (<a href="https://github.com/Microsoft/ApplicationInsights-server-dotnet">https://github.com/Microsoft/ApplicationInsights-server-dotnet</a> ), MsTest, VSO CI.
I granted access to my GitHub repo on the <a href="https://codecov.io">https://codecov.io</a> and got access key.</p>

<!--more-->


<h2>Nuget package</h2>

<p>First I looked at the <a href="https://github.com/codecov/example-csharp">sample repo</a>. When I scrolled through “CI section” and “Combine test and code coverage” it did not seem to be a one click integration… But first instruction was very simple: install <a href="https://www.nuget.org/packages/OpenCover/">OpenCover nuget</a> package. When I installed I noticed that is has documentation in the package and well… when I started reading I almost decided not to proceed. In reality you do not need it when you start. It has a lot of useful information but it is more for fine-tuning.</p>

<h2>Powershell script</h2>

<p>Next step in the instructions is a Powershell script that creates coverage file and uploads it to CodeCov.
Here is <a href="https://github.com/Microsoft/ApplicationInsights-server-dotnet/blob/develop/CodeCov.ps1">my script</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>..\packages\OpenCover.4.6.519\tools\OpenCover.Console.exe -register:user 
</span><span class='line'>  "-target:C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe" 
</span><span class='line'>  "-targetargs:..\a\Release\Src\DependencyCollector\Net40.Tests\Microsoft.ApplicationInsights.DependencyCollector.Net40.Tests.dll  [CUT: all assemblies]  
</span><span class='line'>  ..\a\Release\Src\WindowsServer\WindowsServer.Nuget.Tests\WindowsServer.Nuget.Tests.dll /TestCaseFilter:TestCategory!=Required_4_5_1 /logger:trx" 
</span><span class='line'>  "-filter:+[Microsoft.AI*]* -[*Tests]* -[*TestFramework*]* -[*]Microsoft.ApplicationInsights.Extensibility.Implementation.External*" -hideskipped:All -output:.\coverage.xml
</span><span class='line'>
</span><span class='line'>(New-Object System.Net.WebClient).DownloadFile("https://codecov.io/bash", ".\CodecovUploader.sh")
</span><span class='line'>
</span><span class='line'>$lastCommit = $(git rev-parse HEAD)
</span><span class='line'>
</span><span class='line'>$branchNames = $(git branch --all --contains $lastCommit) 
</span><span class='line'>
</span><span class='line'>$i=0
</span><span class='line'>Foreach ($branchName in $branchNames)
</span><span class='line'>{
</span><span class='line'>    $i++
</span><span class='line'>    if ($i -gt 1)
</span><span class='line'>    {
</span><span class='line'>        $branchName = $branchName.Trim()
</span><span class='line'>      $lastCommitOnBranch = $(git rev-parse $branchName)
</span><span class='line'>        if ($lastCommitOnBranch -eq  $lastCommit)
</span><span class='line'>        {
</span><span class='line'>          if ($branchName.StartsWith("remotes/origin/"))
</span><span class='line'>            {
</span><span class='line'>                $branchName = $branchName.Substring("remotes/origin/".Length)
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            .\CodecovUploader.sh -f coverage.xml -t $env:CODECOVACCESSKEY -X gcov -B $branchName
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>It took me some time to get to it :) So let’s look at it line by line:</p>

<ol>
<li></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>..\packages\OpenCover.4.6.519\tools\OpenCover.Console.exe -register:user 
</span><span class='line'>  "-target:C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe" 
</span><span class='line'>  "-targetargs:..\a\Release\Src\DependencyCollector\Net40.Tests\Microsoft.ApplicationInsights.DependencyCollector.Net40.Tests.dll  [CUT: all assemblies]  
</span><span class='line'>  ..\a\Release\Src\WindowsServer\WindowsServer.Nuget.Tests\WindowsServer.Nuget.Tests.dll /TestCaseFilter:TestCategory!=Required_4_5_1 /logger:trx" 
</span><span class='line'>  "-filter:+[Microsoft.AI*]* -[*Tests]* -[*TestFramework*]* -[*]Microsoft.ApplicationInsights.Extensibility.Implementation.External*" -hideskipped:All -output:.\coverage.xml</span></code></pre></td></tr></table></div></figure>


<p>Here I run <code>OpenCover.Console.exe</code> that is unpacked to the package folder during build. You can check description of all arguments <a href="https://github.com/OpenCover/opencover/wiki/Usage">here</a>.</p>

<p>I think I do not need <code>register</code>. I will try to remove it in the next version. I just kept it from the sample that I used as a start point.</p>

<p>In <code>target</code> and <code>targetargs</code> you specify how to run tests. I opened my VSO build, opened test step and copied the command from there.</p>

<p>In <code>targetargs</code> I specify list of all test assemblies. Notice how “” are placed. It is important! Opening “ should be before the argument or it will not work.</p>

<p><code>/TestCaseFilter</code> is also an argument for <code>vstest.console.exe</code>. I need it for skipping some tests. If you need other vstest arguments read <a href="https://msdn.microsoft.com/en-us/library/jj155800.aspx">this</a></p>

<p>&ldquo;-filter:+[Microsoft.AI<em>]</em> -[<em>Tests]</em> -[<em>TestFramework</em>]<em> -[</em>]Microsoft.ApplicationInsights.Extensibility.Implementation.External*&rdquo; <a href="https://github.com/OpenCover/opencover/wiki/Usage#understanding-filters">means</a> include all types from assemblies which names start with &ldquo;Microsoft.AI&rdquo; except all assemblies that have &ldquo;Tests&rdquo; or &ldquo;TestFramework&rdquo; in the name (otherwise you wound measure code coverage of unit test projects). Also exclude all types from all assemblies where namespace starts with &ldquo;Microsoft.ApplicationInsights.Extensibility.Implementation.External&rdquo;.</p>

<p>You can improve this by:</p>

<ul>
<li>Pass package folder as a parameter. But I was not sure how to propagate properties from MsBuild step to a Powershell step and did not want to spend much time on it.</li>
<li>OpenCover package version is hardcoded meaning that there will be problems with upgrade.</li>
<li><p> Path to vstest.console.exe should also be taken from the environment variable (That should be easy; read [this] (<a href="https://msdn.microsoft.com/en-us/Library/vs/alm/Build/scripts/variables">https://msdn.microsoft.com/en-us/Library/vs/alm/Build/scripts/variables</a>) ).</p></li>
<li></li>
</ul>


<p>Second line is downloading coverage results uploader:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(New-Object System.Net.WebClient).DownloadFile("https://codecov.io/bash", ".\CodecovUploader.sh")</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Now an interesting part starts :) When I was just uploading coverage results (by running <code>CodecovUploader.sh</code>) it was attaching it to a <a href="https://github.com/codecov/example-csharp/issues/9">master branch</a> while I was actually compiling my private branch. What was happening is that VSO instead of just checking out a branch was checking out a commit so branch was in the detached state (so &ldquo;git rev-parse&rdquo; would not work).</p></li>
</ol>


<p>So what I’m doing next is I take last commit of this detached branch and try to figure out on what branch (branches) that commit is the last one and then upload code coverage results on all these branches. If you know an easier way please post a comment! :)</p>

<p>Get last commit of detached branch:
<code>$lastCommit = $(git rev-parse HEAD)</code></p>

<p>Get all branches that have this commit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$branchNames = $(git branch --all --contains $lastCommit)</span></code></pre></td></tr></table></div></figure>


<p>Note that</p>

<ol>
<li>If you just created a local branch from a develop branch and did not make any changes you would have last commit present in your branch and in develop. On both branches that would be the last commit and code coverage would apply to both.</li>
<li>If you have your local branch and made some changes you would have your last commit be present only in one branch.</li>
<li>In reality this command also always returns “master detached” as a first element. We would need to skip it.</li>
</ol>


<p>For each branch that has our commit from detached branch (except the first one which is “detached master”) check that our commit is the last commit for the branch, if yes than upload result:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$i=0
</span><span class='line'>Foreach ($branchName in $branchNames)
</span><span class='line'>{
</span><span class='line'>    $i++
</span><span class='line'>    if ($i -gt 1)
</span><span class='line'>    {
</span><span class='line'>        $branchName = $branchName.Trim()
</span><span class='line'>        $lastCommitOnBranch = $(git rev-parse $branchName)
</span><span class='line'>        if ($lastCommitOnBranch -eq  $lastCommit)
</span><span class='line'>        {
</span><span class='line'>          if ($branchName.StartsWith("remotes/origin/"))
</span><span class='line'>            {
</span><span class='line'>                $branchName = $branchName.Substring("remotes/origin/".Length)
</span><span class='line'>            }
</span><span class='line'>            
</span><span class='line'>            .\CodecovUploader.sh -f coverage.xml -t $env:CODECOVACCESSKEY -X gcov -B $branchName
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Note:</p>

<ul>
<li>You have to Trim branch name; it has leading spaces and &ldquo;git rev-parse&rdquo; would fail without it.</li>
<li>You have to cut &ldquo;remotes/origin/&rdquo; from a branch name because CodeCov does not understand it.</li>
<li><code>$env:CODECOVACCESSKEY</code> is your access key that you get from <a href="https://codecov.io.">https://codecov.io.</a> It is <a href="https://msdn.microsoft.com/en-us/Library/vs/alm/Build/scripts/variables">passed as a variable to the script</a>. You can also pass it as a Powershell script argument if you like.</li>
<li><code>CodecovUploader.sh</code> needs to be run from the git repo root. If you try to do that from a different folder, it will fail. Interestingly enough it opens a new console window, does some magic and immediately closes so if it failed you do not know why. I wonder if there is a good way to detect problems… <a href="https://github.com/codecov/codecov-bash/blob/346e91cb2918fd1d84fde46c0814ae2005fee363/codecov">Here</a> is the list of arguments if you want to check yourself.</li>
</ul>


<p>And Voila! Report is there! :)</p>

<h2>Visualization</h2>

<ol>
<li>I added a badge to my repo main page. To get a badge open you repo info <a href="https://codecov.io/">https://codecov.io/</a>[YourRepo]. Click on the gear button -> badge. Insert markdown code to your readme.md.</li>
<li>Install <a href="https://github.com/codecov/browser-extension#codecov-extension">browser extension</a> to see pull request statistics right on the github.</li>
</ol>


<h2>What I did not like</h2>

<ul>
<li>Tests are executed twice. Once when you run tests in the scope of your build and then to get code coverage. That increases build time. In my case we have 700 unit tests. Build time without code coverage is 9 minutes. With it 14. It is not a big deal with 3 people in the team. But if that would be 10 people with build time increase from 20 to 25 I would doubt if I should add it (Also tests run longer, I had to increase timeouts for some tests) .</li>
<li>I&rsquo;m actually using IE … at work :) I want to have IE extension.</li>
<li>I did not find anything about reports retention policy and did not find how to delete reports.</li>
<li>Well&hellip; It was not really a one click experience since I have VSO CI</li>
<li>Troubleshooting of uploader. I hope I never need it because I would not know immediately how to do this. Also in case of CI I would not even notice that when it got broken if I do not check it for each pull request.</li>
<li>Test containers need to be excluded from the results. It would be nice to exclude them by default.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tx... Network!]]></title>
    <link href="http://sergeysharp.com/blog/2016/02/07/tx-dot-dot-dot-network/"/>
    <updated>2016-02-07T14:56:40-08:00</updated>
    <id>http://sergeysharp.com/blog/2016/02/07/tx-dot-dot-dot-network</id>
    <content type="html"><![CDATA[<p>Recently we have released the new library from <a href="https://github.com/MSOpenTech/Tx">Tx (LINQ to Logs and Traces)</a> family that targets the networking - <a href="https://www.nuget.org/packages/Tx.Network/">Tx.Network</a>. That is the place we are going to publish all parsers/readers/listeners for networking protocols and packet captures files.</p>

<p>In the initial release we have included readers of pcap and pcapng formats, which are very popular among network engineers. Many popular tools like <a href="https://www.wireshark.org/">Wireshark</a> uses PcapNG as a default format for storing of packet captures.</p>

<p>See how that easy to query those:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PcapNg.ReadForward(@"c:\git\tx\traces\snmp.pcapng").Take(5)</span></code></pre></td></tr></table></div></figure>


<p>If you are interested - read <a href="https://github.com/MSOpenTech/Tx/blob/master/Samples/Network/Captures/Readme.md">that documentation</a> how you could use <a href="https://www.nuget.org/packages/Tx.Network/">Tx.Network</a> library for reading network captures of UDP or SNMP datagrams.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Welcome to Binary-in-ETW!]]></title>
    <link href="http://sergeysharp.com/blog/2015/09/28/welcome-to-binary-in-etw/"/>
    <updated>2015-09-28T23:32:24-07:00</updated>
    <id>http://sergeysharp.com/blog/2015/09/28/welcome-to-binary-in-etw</id>
    <content type="html"><![CDATA[<p>One of the most questionable features of ETW, an excellent tracing mechanism, is mixing of serialization with channel itself. This is why we built Binary-in-ETW library that has been released as part of <a href="https://github.com/MSOpenTech/Tx">Tx (LINQ to Logs and Traces)</a>. Now you can use JSON or <a href="https://github.com/Microsoft/bond">Bond&rsquo;s Compact Binary</a> serializations methods or any another ones that could serialize to byte array like Avro, ProtoBuf, BJSON, etc.</p>

<!--more-->


<p>Conceptually we are using ETW event just as an envelope.</p>

<h2>Writing a mixed stream into Binary-in-ETW</h2>

<p>This is how you can write your items of mixed types into the Binary-in-ETW:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var observer = new BinaryEtwObserver();
</span><span class='line'>
</span><span class='line'>// Log a scalar instance
</span><span class='line'>observer.OnNext("Hello");
</span><span class='line'>
</span><span class='line'>// Log an instance of a complex .NET type
</span><span class='line'>observer.OnNext(new MyClass { Value = "Some value " + DateTime.UtcNow });
</span><span class='line'>
</span><span class='line'>// Log a bonded object
</span><span class='line'>observer.OnNext(new ABondClass { StringValue = "Bond: Some another value " + DateTime.UtcNow });
</span></code></pre></td></tr></table></div></figure>


<h2>Reading from Binary-in-ETW</h2>

<p>This is how you can read from ETL files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>playback.AddSequentialBondEtlFiles(@"c:\Data\mixed_000001.etl");
</span><span class='line'>  
</span><span class='line'>playback.GetObservable&lt;string&gt;().Dump();
</span><span class='line'>playback.GetObservable&lt;MyClass&gt;().Dump();
</span><span class='line'>playback.GetObservable&lt;ABondClass&gt;().Dump();
</span><span class='line'>
</span><span class='line'>playback.Run();</span></code></pre></td></tr></table></div></figure>


<h2>Advanced usage (custom serialization)</h2>

<p>If you want to use your own serialization or you just want to store binary data as is, you need to write to <a href="https://github.com/MSOpenTech/Tx/blob/master/Source/Tx.Bond/BinaryEventSource.cs">BinaryEventSource</a> directly, and write an <a href="https://github.com/MSOpenTech/Tx/blob/master/Source/Tx.Core/ITypeMap.cs">ITypeMap</a> implementation that could deserialize stored binary data.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BinaryEventSource.Log.Write(
</span><span class='line'>  occurenceTime : DateTime.UtcNow, // Event creation time; value will be ignored
</span><span class='line'>  receiveTime : DateTime.UtcNow, // Time when event was written  
</span><span class='line'>    protocol : "My Serialization Protocol", // Identifier of the serialization protocol. Value is used when you want to deserialize back
</span><span class='line'>    source : "My Application", // Identifier of your source; value will be ignored
</span><span class='line'>    eventData : new byte[] { ... }, // Payload
</span><span class='line'>    manifestId : "daf0be6e-da1e-5a6a-0d49-69782745c886"); // Identifier of the payload type</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The following protocol identifiers are being used by the library: <code>"JSON"</code>,  <code>"BOND_V1"</code>, <code>"BOND_V2"</code>, <code>"BOND"</code> for JSON, BOND Compact Binary V1, BOND Compact Binary V2 serializations and are reserved. Do not use these names when giving a name for your custom protocol.</p></blockquote>

<p>Next step is to create <a href="https://github.com/MSOpenTech/Tx/blob/master/Source/Tx.Core/ITypeMap.cs">ITypeMap</a> implementation. You can find several samples <a href="https://github.com/MSOpenTech/Tx/tree/master/Source/Tx.Core/TypeMap">here</a>.</p>

<p>And the usage is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>((IPlaybackConfiguration)playback).AddInput(
</span><span class='line'>  () =&gt; BinaryEtwObservable.FromSequentialFiles(@"c:\Data\mixed_000001.etl"),
</span><span class='line'>  typeof(MyCustomTypeMap),
</span><span class='line'>  typeof(GeneralPartitionableTypeMap));
</span><span class='line'>  
</span><span class='line'>playback.GetObservable&lt;MyCustomType&gt;().Dump();
</span><span class='line'>
</span><span class='line'>playback.Run();
</span></code></pre></td></tr></table></div></figure>


<h2>Summary</h2>

<p>If you already use ETW for tracing, consider this extension to log your custom objects, so you do not have to create multiple ETW events that ultimately serve the same purpose. Or if you would want to use this as a redundant output together with the primary ones (e.g. logging of raw web requests or post to an external services) this solution will be an excellent choice too.</p>

<p>Enjoy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Diagnostic of ApplicationInsights SDK]]></title>
    <link href="http://sergeysharp.com/blog/2015/04/16/diagnostic-of-applicationinsights-sdk/"/>
    <updated>2015-04-16T14:07:53-07:00</updated>
    <id>http://sergeysharp.com/blog/2015/04/16/diagnostic-of-applicationinsights-sdk</id>
    <content type="html"><![CDATA[<p>This blog post was written by <a href="https://social.msdn.microsoft.com/Profile/anastasia%20baranchenkova">Anastasia Baranchenkova</a>.</p>

<p>Currently, <a href="http://azure.microsoft.com/en-us/services/application-insights/">Application Insights</a> SDK is in public beta stage, so you cannot expect it to be absolutely stable. Application Insights uses ETW to log its own verbose traces. If you lost any hope to understand why you do not see anything in the portal you may want to get that traces. Often Application Insights developement team would want to take a look at its internal traces in order to diagnose the specific behavior.</p>

<!--more-->


<p>There are several ways how you could collect ETW traces:</p>

<ul>
<li>Use logman to create and capture ETW session to etl file. In this case you could use any tools to visualize captured traces such as <a href="https://github.com/MSOpenTech/Tx/blob/master/Source/Tx.LinqPad/Readme.md">Tx (LINQ to Logs and Traces) LINQpad driver</a>, <a href="http://svcperf.codeplex.com/">SvcPerf</a>, <a href="http://www.microsoft.com/en-us/download/details.aspx?id=28567">PerfView</a>, etc.</li>
<li>Use PerfView to create and capture ETW session directly.</li>
<li>Use logman to create session then use Tx (LINQ to Logs and Traces) LINQpad driver to write standing LINQ query.</li>
</ul>


<p>But there is also a handy nuget package that can simplify that job. Let&rsquo;s look into all that in order.</p>

<h3>Use PerfView to collect traces</h3>

<p>PerfView is a well known tool for CPU and Memory investigations. You can read more on Vance Morrison&rsquo;s <a href="http://blogs.msdn.com/b/vancem/">blog</a>.
To collect AI traces using perfview you would run this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PerfView.exe /onlyProviders=*Microsoft-ApplicationInsights-Extensibility-Web,*Microsoft-ApplicationInsights-Core,
</span><span class='line'>  *Microsoft-ApplicationInsights-Extensibility-RuntimeTelemetry,*Microsoft-ApplicationInsights-Extensibility-WindowsServer,
</span><span class='line'>  *Microsoft-ApplicationInsights-WindowsServer-TelemetryChannel collect</span></code></pre></td></tr></table></div></figure>


<p>You will see something like that:
<img class="center" src="http://sergeysharp.com/images/perfView.ai.jpg"></p>

<p>Events are split into multiple tables and it is hard to filter that or get a general picture what and when was happening if you&rsquo;re using it for the first time.</p>

<h3>Use ApplicationInsights.Diagnostics to collect traces</h3>

<p>This is why we built dedicated easy-to-use <a href="http://www.nuget.org/packages/ApplicationInsights.Diagnostics/">ApplicationInsights.Diagnostics</a> package (which is built on top of <a href="http://www.nuget.org/packages/Microsoft.Diagnostics.Tracing.TraceEvent/">the same library</a> that enpowers PerfView itself).</p>

<p>To get the list of all the verbose traces in <a href="http://www.linqpad.net/">LINQPad</a> you would do the following:</p>

<ul>
<li>Run LINQpad as administartor</li>
<li>Create new query in LINQpad</li>
<li>Add <a href="http://www.nuget.org/packages/ApplicationInsights.Diagnostics/">ApplicationInsights.Diagnostics</a> nuget package (or just open <a href="https://github.com/Tuatan/ApplicationInsights.Diagnostics/tree/master/Samples/HelloWorld.linq">this linq file</a> if you do not have premium features enabled)</li>
<li>Add the following namespaces: <em>System.Reactive.Linq</em>, <em>ApplicationInsights.Diagnostics</em>.</li>
<li>Write the following query: <strong>DiagnosticObservable.Create().Select(i => i.FormattedMessage)</strong></li>
</ul>


<p>You will see something like that:
<img class="center" src="http://sergeysharp.com/images/Linqpad.ai.diagnostics.helloworld.jpg"></p>

<p>If you want to filter the results you can use regular LINQ like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DiagnosticObservable
</span><span class='line'>  .Create()
</span><span class='line'>  .Where(i =&gt; i.FormattedMessage.Contains("localhost"))
</span><span class='line'>  .Select(i =&gt; new 
</span><span class='line'>    {
</span><span class='line'>      i.TimeStamp, 
</span><span class='line'>        i.FormattedMessage, 
</span><span class='line'>        i.EventName, 
</span><span class='line'>        i.ProviderName, 
</span><span class='line'>        i.Level})
</span><span class='line'>  .Dump();</span></code></pre></td></tr></table></div></figure>


<p>The same in Console application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using(DiagnosticObservable
</span><span class='line'>  .Create()
</span><span class='line'>  .Where(i =&gt; i.FormattedMessage.Contains("localhost"))
</span><span class='line'>  .Select(i =&gt; new 
</span><span class='line'>    {
</span><span class='line'>      i.TimeStamp, 
</span><span class='line'>        i.FormattedMessage, 
</span><span class='line'>        i.EventName, 
</span><span class='line'>        i.ProviderName, 
</span><span class='line'>        i.Level})
</span><span class='line'>  .Subscribe(i =&gt; Console.WriteLine("{0} {1} {2} {3} {4}",
</span><span class='line'>      i.TimeStamp, 
</span><span class='line'>        i.FormattedMessage, 
</span><span class='line'>        i.EventName, 
</span><span class='line'>        i.ProviderName, 
</span><span class='line'>        i.Level))
</span><span class='line'> {
</span><span class='line'>  Console.ReadKey();
</span><span class='line'> }</span></code></pre></td></tr></table></div></figure>


<h3>Summary</h3>

<p>You could find more samples <a href="https://github.com/Tuatan/ApplicationInsights.Diagnostics/tree/master/Samples">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LINQ to Application Insights Live Session]]></title>
    <link href="http://sergeysharp.com/blog/2015/04/14/linq-to-applicationinsights-live-sessions/"/>
    <updated>2015-04-14T09:45:51-07:00</updated>
    <id>http://sergeysharp.com/blog/2015/04/14/linq-to-applicationinsights-live-sessions</id>
    <content type="html"><![CDATA[<p>When working with ApplicationInsights you sometimes need to see whether data is sent out. For that purposes you can use <a href="http://www.telerik.com/fiddler">Fiddler</a>.</p>

<p>But also sometimes you want to filter that data, find some specific events or metrics, from certain users or with certain customer properties.</p>

<p>With <a href="http://www.nuget.org/packages/Tx.ApplicationInsights.Session/">Tx.ApplicationInsights.Session nuget</a> you can create a live session and run LINQ queries to filter data.</p>

<!--more-->


<p>Here is the example:</p>

<ul>
<li>Open your application that is integrated with ApplicationInsights (<a href="http://azure.microsoft.com/en-us/documentation/articles/app-insights-get-started/">http://azure.microsoft.com/en-us/documentation/articles/app-insights-get-started/</a>).</li>
<li>Open ApplicationInsights.config and add TelemetryChannel tag under root ApplicationInsights tag.</li>
</ul>


<p>For 0.13 - 0.14.1 SDK:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;TelemetryChannel&gt;
</span><span class='line'>    &lt;EndpointAddress&gt;http://localhost:1234/&lt;/EndpointAddress&gt;
</span><span class='line'>  &lt;/TelemetryChannel&gt;</span></code></pre></td></tr></table></div></figure>


<p>For 0.14.1 and later</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;TelemetryChannel Type="Microsoft.ApplicationInsights.Channel.PersistenceChannel, Microsoft.ApplicationInsights.PersistenceChannel"&gt;
</span><span class='line'>    &lt;EndpointAddress&gt;http://localhost:1234/&lt;/EndpointAddress&gt;
</span><span class='line'>  &lt;/TelemetryChannel&gt;</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Add and run this code in <a href="http://www.linqpad.net/">LinqPad</a>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>playback.AddApplicationInsightsSession("http://localhost:1234/");
</span><span class='line'>
</span><span class='line'>playback
</span><span class='line'>  .GetObservable&lt;Envelope&lt;RequestData&gt;&gt;()
</span><span class='line'>  .Dump();
</span><span class='line'>
</span><span class='line'>playback.Start();   </span></code></pre></td></tr></table></div></figure>


<p>or add and run this code in regular console application. Make sure that the following namespaces are being added: <em>System.Reactive</em>, <em>Tx.ApplicationInsights.Session</em> and <em>Tx.ApplicationInsights.Session.TelemetryType</em>.</p>

<ul>
<li>Start your sample application. When it starts generating request telemetry you will see requests being logged in LinqPad/Console Application.</li>
</ul>


<p>Your application will send data to <a href="http://localhost:1234/">http://localhost:1234/</a> so you can inspect it but data will not be forwarded to your AI production endpoint.</p>

<p>Now you can modify this example to filter data using regular LINQ.</p>

<p>Currently the library supports all 10 ApplicationInsights telemetry types (They all are in <em>Tx.ApplicationInsights.Session.TelemetryType</em> namespace).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LINQ to Application Insights Traces]]></title>
    <link href="http://sergeysharp.com/blog/2015/03/26/linq-for-application-insights-traces/"/>
    <updated>2015-03-26T15:54:43-07:00</updated>
    <id>http://sergeysharp.com/blog/2015/03/26/linq-for-application-insights-traces</id>
    <content type="html"><![CDATA[<p><a href="http://azure.microsoft.com/en-us/services/application-insights/">Application Insights</a> has 7 days retention policy. You can run quite complicated queries using Metric and Search explorers but if you need to analyze historical data you need to use Continuous Export feature. You can read more about setting up Continuous Exports <a href="http://azure.microsoft.com/en-us/documentation/articles/app-insights-export-telemetry/">here</a>.</p>

<p>Now what data is stored in Azure Blob Storage you can would want to query it. <a href="http://tx.codeplex.com/">Tx (LINQ to Logs and Traces)</a> library allows you to run Language Integrated Query (LINQ) directly on raw event sources: ad-hoc query on past history in trace and log files and standing queries on real-time feeds, such as Event Tracing for Windows (ETW) sessions. In the <a href="http://www.linqpad.net/">LINQPad</a> experience of Tx is as if all the events were in a database, except, no database is involved - the query happens directly on raw logs/traces. And now Tx supports Application Insights data format.</p>

<!--more-->


<p>There are 2 Nuget packages to work with Application Insights data:</p>

<ul>
<li><a href="http://www.nuget.org/packages/Tx.ApplicationInsights.Azure/">Tx.ApplicationInsights.Azure</a> allows you to query Azure Blob, dump files on disk and create queries against that.</li>
<li><a href="http://www.nuget.org/packages/Tx.ApplicationInsights/">Tx.ApplicationInsights</a> allows you to do the same but as an input requires location of files preloaded from the Azure Blob</li>
</ul>


<p>Benefits of this approach are:</p>

<ul>
<li>You can query historical data using well-known LINQ language</li>
<li>You can query Application Insights data with data from different streams (Tx also supports IIS logs, ETW traces and other trace formats.)</li>
<li>Tx is optimized for evaluating single-pass queries for multiplexed streams.</li>
<li>For more see <a href="https://github.com/MSOpenTech/Tx/blob/master/Doc/PlaybackFeatures.md">Features of Playback</a>.</li>
</ul>


<h2>Examples</h2>

<h3>Simple way to query from a local folder</h3>

<p>How to setup ApplicationInsights</p>

<ul>
<li>Add <a href="http://www.nuget.org/packages/Tx.ApplicationInsights/">Tx.ApplicationInsights</a> nuget package to your project. See <a href="http://docs.nuget.org/consume/package-manager-dialog#Finding-a-Package">this</a> for details.</li>
<li>Add the following namespaces to a class: <em>System.Reactive</em> and <em>Tx.ApplicationInsights.TelemetryType</em></li>
<li>Copy and paste the following code:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ApplicationInsightsFileStorage 
</span><span class='line'>  .ReadFromFiles&lt;CustomEvent&gt;( 
</span><span class='line'>      @"C:\Data\AppInsights\app1_6017e369258e42cc8cee20cd1956c3d2", 
</span><span class='line'>      @"C:\Data\AppInsights\app2_4e49badc530d4187acc4c42e5e7d9ebe")    
</span><span class='line'>  .SelectMany(i =&gt; i.@event);</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Specify correct folder names. You can any number of folders or one parent folder</li>
<li>Hit F5 and get your results</li>
</ul>


<h3>More complicated way to query from a local folder</h3>

<p>As explained earlier ApplicationInsightsFileStorage.ReadFromFiles is just a convenient method that you can use if you do not need to create complicated correlation queries. Same results you would get with this code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>playback.AddApplicationInsightsFiles(
</span><span class='line'>  @"" // &lt;- put here collection of directory paths containing .blob files
</span><span class='line'>);
</span><span class='line'>
</span><span class='line'>var query = playback.GetObservable&lt;CustomEvent&gt;().SelectMany(i =&gt; i.@event);
</span><span class='line'>
</span><span class='line'>// If you are using LINQPad you could just dump the results
</span><span class='line'>// query.Dump();
</span><span class='line'>
</span><span class='line'>// Otherwise you could print them to console.
</span><span class='line'>query
</span><span class='line'>  .Subscribe(i =&gt; Console.WriteLine(i));
</span><span class='line'>
</span><span class='line'>playback.Run();</span></code></pre></td></tr></table></div></figure>


<h3>Cache files from Azure blob storage</h3>

<ul>
<li>Add <a href="http://www.nuget.org/packages/Tx.ApplicationInsights.Azure/">Tx.ApplicationInsights.Azure</a> nuget package to your project. See <a href="http://docs.nuget.org/consume/package-manager-dialog#Finding-a-Package">this</a> for details.</li>
<li>Add the following namespaces to a class: <em>System.Reactive</em></li>
<li>Copy and paste the following code:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ApplicationInsightsAzureStorage
</span><span class='line'>  .Cache(
</span><span class='line'>      @"DefaultEndpointsProtocol=https;AccountName=#accountName#;AccountKey=#accountKey#",
</span><span class='line'>      @"#containerName#",
</span><span class='line'>      @"C:\AppInsights\");</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Run the query (F5), then <strong>ApplicationInsightsStorage</strong> will fetch blob storage container and will iterate through stored there files and cache them into specified local folder if needed.</li>
</ul>


<h3>Simple way to query from Azure blob storage</h3>

<p>There is a way how you could download and immediately query files from configurd Azure storage.</p>

<ul>
<li>Add <a href="http://www.nuget.org/packages/Tx.ApplicationInsights.Azure/">Tx.ApplicationInsights.Azure</a> nuget package to your project. See <a href="http://docs.nuget.org/consume/package-manager-dialog#Finding-a-Package">this</a> for details.</li>
<li>Add the following namespaces to a class: <em>System.Reactive</em>, <em>Tx.ApplicationInsights</em> and <em>Tx.ApplicationInsights.TelemetryType</em></li>
<li>Copy and paste the following code:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ApplicationInsightsAzureStorage
</span><span class='line'>  .ReadFromFiles&lt;CustomEvent&gt;(
</span><span class='line'>      @"DefaultEndpointsProtocol=https;AccountName=#accountName#;AccountKey=#accountKey#",
</span><span class='line'>      @"#containerName#",
</span><span class='line'>      @"C:\AppInsights\")
</span><span class='line'>  .Where(item =&gt; item.Context.Operation.Id == "12345");</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Hit F5, then <strong>ApplicationInsightsStorage</strong> will fetch blob storage container and will iterate through stored there files and cache them into specified local folder if needed, then it reads and parses those files to return custom events with specified operation id.</li>
</ul>


<h3>More complicated way to query from Azure blob storage</h3>

<p>Under the cover <strong>ApplicationInsightsAzureStorage</strong> is doing some work for you. You will get the same results if you write:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>playback.AddApplicationInsightsStorage(
</span><span class='line'>  @"DefaultEndpointsProtocol=https;AccountName=#accountName#;AccountKey=#accountKey#", 
</span><span class='line'>  @"#containerName#",
</span><span class='line'>  @"C:\AppInsights\");
</span><span class='line'>
</span><span class='line'>var query = playback
</span><span class='line'>  .GetObservable&lt;CustomEvent&gt;()
</span><span class='line'>  .Where(item =&gt; item.Context.Operation.Id == "12345");
</span><span class='line'>
</span><span class='line'>// If you are using LINQPad you could just dump the results
</span><span class='line'>// query.Dump();
</span><span class='line'>
</span><span class='line'>// Otherwise you could print them to console.
</span><span class='line'>query
</span><span class='line'>  .Subscribe(i =&gt; Console.WriteLine(i));
</span><span class='line'>
</span><span class='line'>playback.Run();</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Results will be the same as in the first example but this approach is more flexible. We will look into more complicated example that uses buffers for which you need Observables.</li>
</ul>


<h3>Correlate Performance counters and Request</h3>

<p>And here is the most advanced sample. It demonstrates how to write queries which use several Application Insights telemetry types, buffers and schedulers. We assume that you understand Rx, Observables and Tx to understand this sample. This code will return all requests that happened when performance counter &ldquo;CPU % Total&rdquo; value is more that 70 during 5 minutes interval.</p>

<ul>
<li>Add <a href="http://www.nuget.org/packages/Tx.ApplicationInsights/">Tx.ApplicationInsights</a> nuget package to your project. See <a href="http://docs.nuget.org/consume/package-manager-dialog#Finding-a-Package">this</a> for details.</li>
<li>Add the following namespaces to a class: <em>System.Reactive</em>, <em>System.Reactive.Linq</em> and <em>Tx.ApplicationInsights.TelemetryType</em></li>
<li>Copy and paste the following code:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>playback.AddApplicationInsightsFiles(
</span><span class='line'>  @"" // &lt;- put here collection of directory paths containing .blob files
</span><span class='line'>);
</span><span class='line'>
</span><span class='line'>var query = playback
</span><span class='line'>  .GetObservable&lt;RequestEvent&gt;()
</span><span class='line'>  .Select(requestEvent =&gt; (BaseEvent)requestEvent)
</span><span class='line'>  .Merge(playback
</span><span class='line'>          .GetObservable&lt;PerformanceCountersEvent&gt;()
</span><span class='line'>          .Select(performanceCountersEvent =&gt; (BaseEvent)performanceCountersEvent), 
</span><span class='line'>      playback.Scheduler)
</span><span class='line'>  .Buffer(TimeSpan.FromMinutes(10), TimeSpan.FromMinutes(5), playback.Scheduler)
</span><span class='line'>  .Where(buffer =&gt; buffer.Length &gt; 0 && buffer.OfType&lt;RequestEvent&gt;().Count() &gt; 0 && buffer.OfType&lt;PerformanceCountersEvent&gt;().Count() &gt; 0)
</span><span class='line'>  .Select(buffer =&gt;
</span><span class='line'>  {
</span><span class='line'>      var cpuTotals = buffer
</span><span class='line'>          .OfType&lt;PerformanceCountersEvent&gt;()
</span><span class='line'>          .SelectMany(performanceCountersEvent =&gt; performanceCountersEvent.PerformanceCounters)
</span><span class='line'>          .SelectMany(performanceCounter =&gt;
</span><span class='line'>          {
</span><span class='line'>              return performanceCounter.Values
</span><span class='line'>                  .Select(i =&gt; new 
</span><span class='line'>                  {
</span><span class='line'>                      Name = string.Format(
</span><span class='line'>                          @"{0}/{1}/{2}"
</span><span class='line'>                          performanceCounter.CategoryName,
</span><span class='line'>                          performanceCounter.InstanceName,
</span><span class='line'>                          i.Key),
</span><span class='line'>                      Value = i.Value
</span><span class='line'>                  })
</span><span class='line'>              
</span><span class='line'>          })
</span><span class='line'>          .Where(metric =&gt; metric.Name == @"Processor/_Total/percentage_processor_total")
</span><span class='line'>          .Select(metric =&gt; metric.Value)
</span><span class='line'>          .ToArray();
</span><span class='line'>
</span><span class='line'>      if (cpuTotals.Length &gt; 0 && cpuTotals.Average() &gt; 70)
</span><span class='line'>      {
</span><span class='line'>          return new
</span><span class='line'>          {
</span><span class='line'>              Requests = buffer
</span><span class='line'>                  .OfType&lt;RequestEvent&gt;()
</span><span class='line'>                  .ToArray(),
</span><span class='line'>              CpuTotals = cpuTotals
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      return null;
</span><span class='line'>  })
</span><span class='line'>  .Where(signal =&gt; signal != null);
</span><span class='line'>
</span><span class='line'>// If you are using LINQPad you could just dump the results
</span><span class='line'>// query.Dump();
</span><span class='line'>
</span><span class='line'>// Otherwise you could print them to console.
</span><span class='line'>query
</span><span class='line'>  .Subscribe(i =&gt; Console.WriteLine(i));
</span><span class='line'>
</span><span class='line'>playback.Run(); </span></code></pre></td></tr></table></div></figure>


<p>This sample is rather complex, let&rsquo;s split it into several fragments:</p>

<p>As a first step we need to create Playback instance and register input source for it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var playback = new Playback();
</span><span class='line'>
</span><span class='line'>// Initialize input source for playback
</span><span class='line'>playback.AddApplicationInsightsFiles(
</span><span class='line'>  @"" // &lt;- put here collection of directory paths containing .blob files
</span><span class='line'>);</span></code></pre></td></tr></table></div></figure>


<p>Then we need to created merged stream of request and performance counter telemetry event streams:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var mergedStream = playback
</span><span class='line'>  .GetObservable&lt;RequestEvent&gt;()
</span><span class='line'>  .Select(requestEvent =&gt; (BaseEvent)requestEvent)
</span><span class='line'>  .Merge(playback
</span><span class='line'>          .GetObservable&lt;PerformanceCountersEvent&gt;()
</span><span class='line'>          .Select(performanceCountersEvent =&gt; (BaseEvent)performanceCountersEvent), 
</span><span class='line'>      playback.Scheduler);</span></code></pre></td></tr></table></div></figure>


<p>Next step is to apply hopping time window, which produces 5 minutes long batches of events:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var batches = mergedStream
</span><span class='line'>  .Buffer(TimeSpan.FromMinutes(10), TimeSpan.FromMinutes(5), playback.Scheduler);</span></code></pre></td></tr></table></div></figure>


<p>After that we could apply our custom logic for individual batches:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var query = batches
</span><span class='line'>  .Select(buffer =&gt;
</span><span class='line'>  {
</span><span class='line'>      var cpuTotals = buffer
</span><span class='line'>          .OfType&lt;PerformanceCountersEvent&gt;()
</span><span class='line'>          .SelectMany(performanceCountersEvent =&gt; performanceCountersEvent.PerformanceCounters)
</span><span class='line'>          .SelectMany(performanceCounter =&gt;
</span><span class='line'>          {
</span><span class='line'>              return performanceCounter.Values
</span><span class='line'>                  .Select(i =&gt; new 
</span><span class='line'>                  {
</span><span class='line'>                      Name = string.Format(
</span><span class='line'>                          @"{0}/{1}/{2}"
</span><span class='line'>                          performanceCounter.CategoryName,
</span><span class='line'>                          performanceCounter.InstanceName,
</span><span class='line'>                          i.Key),
</span><span class='line'>                      Value = i.Value
</span><span class='line'>                  })
</span><span class='line'>              
</span><span class='line'>          })
</span><span class='line'>          .Where(metric =&gt; metric.Name == @"Processor/_Total/percentage_processor_total")
</span><span class='line'>          .Select(metric =&gt; metric.Value)
</span><span class='line'>          .ToArray();
</span><span class='line'>
</span><span class='line'>      if (cpuTotals.Length &gt; 0 && cpuTotals.Average() &gt; 70)
</span><span class='line'>      {
</span><span class='line'>          return new
</span><span class='line'>          {
</span><span class='line'>              Requests = buffer
</span><span class='line'>                  .OfType&lt;RequestEvent&gt;()
</span><span class='line'>                  .ToArray(),
</span><span class='line'>              CpuTotals = cpuTotals
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      return null;
</span><span class='line'>  })
</span><span class='line'>  .Where(signal =&gt; signal != null);
</span></code></pre></td></tr></table></div></figure>


<p>And the last step is to use convinient Dump method on result query and start the playback.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>query.Dump();
</span><span class='line'>
</span><span class='line'>playback.Run(); </span></code></pre></td></tr></table></div></figure>


<p>You could find more samples <a href="https://github.com/Tuatan/tx.appinsights/tree/master/Samples">here</a>, in the official GitHub repository of this project.</p>

<h3>Summary</h3>

<p>Now you know how you could query Application Insights Continious Export telemetry files.</p>
]]></content>
  </entry>
  
</feed>
